{% extends "review/base.html" %}
{% load staticfiles %}
{% load template_tags %}

{% block css %}
	<link rel="stylesheet" href="{% static 'review/jstree.min.css' %}" />
	<link rel="stylesheet" href='{% static "review/annotator.min.css" %}'>
{% endblock %}



{% block content %}

	<p><a class="btn btn-default" href="/">&laquo; back</a></p>

	{% if is_owner %}
		<h1>Viewing submission for {{ submission.assignment.name }}</h1>

		
	<hr/>

		<div class="row">
			<div class="col-lg-2 col-md-2 col-sm-3"></div>
			<div class="col-lg-10 col-md-10 col-sm-9">
				<ul class="nav nav-tabs" role="tablist">
				    <li class="active submission-tab" data-id="0">
				    	<a href="#" role="tab" data-toggle="tab">Original</a>
				    </li>
				    {% for i in reviews|get_range %}
		      			<li class="submission-tab" data-id="{{ i }}">
		      				<a href="#" role="tab" data-toggle="tab">Review {{ i }}</a>
		      			</li>
				    {% endfor %}
				</ul>
			</div>
		</div>
		<br>

	{% endif %}	

	{% if not is_owner %}
		<h1>Reviewing submission for {{ submission.assignment.name }}</h1>

	<hr/>
	{% endif %}
	

	<div class="row">
        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-12">
        	<p class="glyphicon glyphicon-folder-open"></p>
            <div id="filetree"></div>
        </div>
        <div class="col-lg-10 col-md-10 col-sm-9 col-xs-12">
			 <pre id="filecontents">No file selected.</pre>
        </div>
    </div>

	{% if not is_owner %}
		<div class="row">
			<div class="review-buttons">
			  <button type="button" class="btn btn-default">Save</button>
			  <button type="button" class="btn btn-default">Cancel</button>
			  <button type="button" class="btn btn-default">Submit</button>
			</div>
		</div>
	{% endif %}

	
{% endblock %}

{% block jsEnd %}
	<script src="{% static 'review/jstree.min.js' %}"></script>
	<script src='{% static "review/annotator-full.min.js" %}'></script>
	<script type="text/javascript">
		//TODO - This is a fake user
		var currentUserID = {{ user }};
		var currentSubmissionFile;

		var content;

		var activeTab = "0"; //0 represents original, other numbers represent the reviews
		var reviews = {{ reviews|safe }};
		var fileStructure = {{ file_structure|safe }};
		var is_reviewer = ! {{ is_owner|yesno:"true,false" }};

		$('.submission-tab').click(function(){
			var clickedTab = $(this).data('id')
			if($(this).data('id') != activeTab){
				activeTab = clickedTab;
				if (clickedTab == '0'){
					clearComments();
				}else{
					loadComments();
				}
			}
		})

		$(document).ready( function() {
		  $(function () { 
		  	$('#filetree').on('changed.jstree', function (e, data) {
			    var node = data.instance.get_node(data.selected);
			    //Check for children. If they exist, the node is a directory.
			    if(node.children.length == 0){
			    	var path = "";
				    for(var i=node.parents.length-1; i >= 0; i--){
				    	path += node.parents[i];
				    	path += '/';
				    }
				    path += node.id;
				    data = {
				    	path: path,
				    	submission_id: {{ submission.id }},
				    	csrfmiddlewaretoken: '{{ csrf_token }}'
				    };
				    $.ajax({
			        type: "POST",
			        url: "/app/get_submission_file/",
			        data: data,
			        success: function(data) {
            			$('#filecontents').text(data.file_contents);
            			currentSubmissionFile = data.submission_file_id;
            			if(is_reviewer){
							activateAnnotator(data.submission_file_id, currentUserID);
						}else if(activeTab != 0){
							loadComments();
						}
        			}   
     				}); 
			    }else{
			    	// If folder is selected, set text to show no file selected.
			    	$('#filecontents').text("No file selected.");
			    }
			  }).on('loaded.jstree', function (e, data){
			  	loadTreeIcons();
			  // }).on('open_node.jstree', function (e, data){
			  // 	loadTreeIcons();
			  }).on('close_node.jstree', function (e, data){
			  	console.log("!");
			  	loadTreeIcons();	
			  }).jstree(fileStructure)});
		});
		
		function activateAnnotator(submissionFileID, userID){
			console.log("Activating annotator");

			clearComments();

			//Set annoations as read only if not a reviewer.
			if(!is_reviewer){
				content = $('#filecontents').annotator({readOnly: true});
			}else{
				content = $('#filecontents').annotator();
			}

			content.annotator('addPlugin', 'Store', {
			  // The endpoint of the store on your server.
	     	prefix: '/app/annotator_api',

	      // Attach the uri of the current page to all annotations to allow search.
	      annotationData: {
	        'uri': submissionFileID + '+' + userID,
	      },

	      // This will perform a "search" action when the plugin loads. Will
	      // request all notations for the given ID.
	      loadFromSearch: {
	        'uri': submissionFileID + '+' + userID,
      	}
			});
		}

		function loadComments(){
			var review = reviews[parseInt(activeTab)-1];
			if(currentSubmissionFile){
				console.log(review.user_id);
				activateAnnotator(currentSubmissionFile, review.user_id);
			}
		}

		function clearComments(){
			if(content != null){
				content.annotator('destroy');
				content = null;
			}
		}

	function loadTreeIcons(){
		console.log("go");
		$('.jstree-themeicon-hidden').each(function() {
			// console.log($(this).parent().parent());
			if($(this).parent().parent().hasClass("jstree-leaf")){
				$(this).removeClass('jstree-icon jstree-themeicon jstree-themeicon-hidden').addClass('glyphicon glyphicon-file');
			}else if($(this).parent().parent().hasClass("jstree-closed")){
				$(this).removeClass('jstree-icon jstree-themeicon jstree-themeicon-hidden').addClass('glyphicon glyphicon-folder-close');
			}else{
				$(this).removeClass('jstree-icon jstree-themeicon jstree-themeicon-hidden').addClass('glyphicon glyphicon-folder-open');
			}
			
		});
	}

	</script>
{% endblock %}